# https://www.kesis.net/sub/sub_0003.jsp?M_MENU_ID=M_M_002&S_MENU_ID=S_M_011 
import pandas as pd
import datetime
 
import os
import openpyxl
 
 
import requests
from bs4 import BeautifulSoup
import re
 
 
MainDirectory = os.path.abspath(os.path.dirname(__file__))
os.chdir(MainDirectory)
 
#%%
 
 
####### Take HTML content
MainURL = 'https://www.eex.com/en/markets/trading-ressources/calendar'
page = requests.get(MainURL)
 
soup = BeautifulSoup(page.content, 'html.parser')
 
 
####### Find a list of URL's with 'zip'
TrDataList = soup.find_all("tr")
# TrDataList[0]
        
ListOfA = []
for Tr in TrDataList:
    
    if Tr.find_all('td', {"data-field": 'title'}, re.compile("EUA Primary Auction Calendar History") ) and\
        Tr.find_all('a', href=re.compile("zip") ):
            
        ListOfA.append( Tr.find('a')['href'] )
    
 
urlList = ['https://www.eex.com'+ListElm for ListElm in ListOfA]
 
 
####### Filter Current Year data from URL zip list
CurrentYear = datetime.date.today().year
 
urlAuctionCalendarCurrentYear = [ListElm for ListElm in urlList if str(CurrentYear) in ListElm][0]
AuctionCalendarCurrentYearFileName = urlAuctionCalendarCurrentYear.split('/')[-1]
 
 
####### Download and Save Data For Current Year
response = requests.get(urlAuctionCalendarCurrentYear)
if response.status_code == 200:
    with open(MainDirectory+'\\'+ AuctionCalendarCurrentYearFileName, 'wb') as f:
        f.write(response.content) 
